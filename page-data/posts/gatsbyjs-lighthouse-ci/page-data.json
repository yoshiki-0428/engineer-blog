{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/gatsbyjs-lighthouse-ci","result":{"data":{"markdownRemark":{"id":"6aeb7ae5-6fd4-55cb-b64c-13da30f4c50b","html":"<h1 id=\"はじめに\" style=\"position:relative;\"><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\" aria-label=\"はじめに permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>はじめに</h1>\n<p>Webサイトをデプロイしたはいいけど、いちいち<a href=\"https://chrome.google.com/webstore/detail/lighthouse/blipmdconlkpinefehnmjammfjpmpbjk?hl=ja\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Lighthouse</a>のChrome Tabでのサイト観測が手間かかる！ってこと結構あると思います。（ていうかパフォーマンス計測忘れがち）</p>\n<blockquote>\n<p>Lighthouseとは？\nオープンソースの自動化されたツールでウェブアプリ、ウェブサイトのパフォーマンス計測に役立ちます。</p>\n</blockquote>\n<p>ということで面倒なことはCIにやらせましょうということで、GitHub Actions を使用したLighthouse CIの実行手順をここに記載しておきます。</p>\n<p>注意としてはあくまでビルドされた生成物をCI上のLocalhostでの計測のためデプロイ先のWebサーバの速度ではないということです。</p>\n<p>それではやってみましょう！</p>\n<h1 id=\"ymlファイルをつくる\" style=\"position:relative;\"><a href=\"#yml%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B\" aria-label=\"ymlファイルをつくる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ymlファイルをつくる</h1>\n<p><strong>.github/workflows/lighthouse-ci.yml</strong> をリポジトリ内に追加します。</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build project and Run Lighthouse CI\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">lhci</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Lighthouse CI\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Use Node.js 12.x\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> 12.x\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> npm install<span class=\"token punctuation\">,</span> build\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">YOUR_ENV</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.YOUR_ENV <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          npm install\n          npm run build</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> run Lighthouse CI\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          npm install -g @lhci/cli@0.3.x\n          lhci autorun --upload.target=temporary-public-storage --staticDistDir=./public || echo \"LHCI failed!\"</span></code></pre></div>\n<p>ポイント的にはnpm i ~ build をちゃんとする（それはそう）こととLighthouse CIの<strong>staticDistDir=./public</strong>の指定先を間違えないことです。</p>\n<p>プロジェクトによって出力先が違うのでbuildして確認しましょう。</p>\n<h1 id=\"pushする\" style=\"position:relative;\"><a href=\"#push%E3%81%99%E3%82%8B\" aria-label=\"pushする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pushする</h1>\n<p>リポジトリにPushしてCIが起動していることを確認しましょう。ビルドまで通ればLighthouse CIが自動的に3回確認してくれるはずです。</p>\n<blockquote>\n<p>3回やるのは平均値を取るためらしいです</p>\n</blockquote>\n<p><img src=\"https://img.esa.io/uploads/production/attachments/15569/2020/10/09/84487/ccef0bd9-85ac-4a6b-aac7-fd0839093bc2.png\"></p>\n<p>成功するとCI上で計測結果のURLが表示されています。アクセスして確認しましょう。</p>\n<p><img src=\"https://img.esa.io/uploads/production/attachments/15569/2020/10/09/84487/e61df45a-1acc-492b-b478-5636704700e5.png\"></p>\n<p>前回の計測結果があるとどう変わったか可視化してくれます。こんな機能あったんですね。（知らなかった。。。）</p>\n<p><img src=\"https://img.esa.io/uploads/production/attachments/15569/2020/10/09/84487/ab73c1b6-a1bd-450b-afd4-29cf3363a41b.png\"> </p>\n<h1 id=\"ci結果をslackに通知する\" style=\"position:relative;\"><a href=\"#ci%E7%B5%90%E6%9E%9C%E3%82%92slack%E3%81%AB%E9%80%9A%E7%9F%A5%E3%81%99%E3%82%8B\" aria-label=\"ci結果をslackに通知する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CI結果をSlackに通知する</h1>\n<p>残念ながらLighthouse CIの測定結果はコンソールに出力されているだけです。なので測定されたURLを取得するのは厳しそうなのでGitHub ActionsのCI結果をSlackに通知してあげましょう。</p>\n<p>先程作成した<strong>.github/workflows/lighthouse-ci.yml</strong>に新しいJobを追加します。環境変数として <strong>SLACK<em>WEBHOOK</em>URL</strong> が必要なので<a href=\"https://slack.com/intl/ja-jp/help/articles/115005265063-Slack-%E3%81%A7%E3%81%AE-Incoming-Webhook-%E3%81%AE%E5%88%A9%E7%94%A8\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Slack Incomming HookのURL</a>を取得しましょう（略）</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">  <span class=\"token key atrule\">slack-notify</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Slack Notification\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set COMMIT_MESSAGE\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>set<span class=\"token punctuation\">-</span>env name=COMMIT_MESSAGE<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>$(echo \"$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.head_commit.message <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\" <span class=\"token punctuation\">|</span> tr '\\n' ' ')\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Slack Notification on SUCCESS\n      <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> success()\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> tokorom/action<span class=\"token punctuation\">-</span>slack<span class=\"token punctuation\">-</span>incoming<span class=\"token punctuation\">-</span>webhook@master\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">INCOMING_WEBHOOK_URL</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SLACK_WEBHOOK_URL <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">text</span><span class=\"token punctuation\">:</span> Successfully GitHub Actions<span class=\"token tag\">!</span>\n        <span class=\"token key atrule\">attachments</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          [\n            {\n              \"color\": \"good\",\n              \"author_name\": \"GitHub Actions Notify\",\n              \"author_icon\": \"${{ github.event.sender.avatar_url }}\",\n              \"fields\": [\n                {\n                  \"title\": \"Repository\",\n                  \"value\": \"${{ github.repository }}\"\n                },\n                {\n                  \"title\": \"Commit Message\",\n                  \"value\": \"${{ env.COMMIT_MESSAGE }}\"\n                },\n                {\n                  \"title\": \"GitHub Actions URL\",\n                  \"value\": \"${{ github.event.repository.url }}/actions/runs/${{ github.run_id }}\"\n                },\n                {\n                  \"title\": \"Compare URL\",\n                  \"value\": \"${{ github.event.compare }}\"\n                }\n              ]\n            }\n          ]</span></code></pre></div>\n<p>うまくいくとこんな感じになります。</p>\n<p><img src=\"https://img.esa.io/uploads/production/attachments/15569/2020/10/10/84487/825ab829-631a-48ed-8b04-8dc25836db1e.png\"></p>\n<h1 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h1>\n<p>いかがでしたでしょうか。実作業含めても30分程度でできるので是非導入してみてはいかがでしょうか。それでは良いCI/CDライフを！</p>\n<h1 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h1>\n<ul>\n<li><a href=\"https://github.com/GoogleChrome/lighthouse-ci\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/GoogleChrome/lighthouse-ci</a></li>\n<li><a href=\"https://github.com/GoogleChromeLabs/lighthousebot\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/GoogleChromeLabs/lighthousebot</a></li>\n<li><a href=\"https://spinners.work/posts/github-actions-context/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://spinners.work/posts/github-actions-context/</a></li>\n</ul>","fields":{"slug":"/posts/gatsbyjs-lighthouse-ci","tagSlugs":["/tags/ci-cd/"]},"frontmatter":{"date":"2020-10-09T09:00:00.000Z","updatedDate":"2020-10-10T09:00:00.000Z","tags":["CI/CD"],"title":"Lighthouse CIを使用してサイト速度をコミット単位で確認する","socialImage":"https://ucarecdn.com/c888768a-1a82-40ed-8e22-90ba29c5e962/","category":"Programming"},"excerpt":"はじめに Webサイトをデプロイしたはいいけど、いちいちLighthouseのChrome Tabでのサイト観測が手間かかる！ってこと結構あると思います。（ていうかパフォーマンス計測忘れがち） Lighthouseとは？\nオープンソースの自動化されたツールでウェブアプリ、ウェブ…","tableOfContents":"<ul>\n<li><a href=\"/posts/gatsbyjs-lighthouse-ci/#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\">はじめに</a></li>\n<li><a href=\"/posts/gatsbyjs-lighthouse-ci/#yml%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B\">ymlファイルをつくる</a></li>\n<li><a href=\"/posts/gatsbyjs-lighthouse-ci/#push%E3%81%99%E3%82%8B\">Pushする</a></li>\n<li><a href=\"/posts/gatsbyjs-lighthouse-ci/#ci%E7%B5%90%E6%9E%9C%E3%82%92slack%E3%81%AB%E9%80%9A%E7%9F%A5%E3%81%99%E3%82%8B\">CI結果をSlackに通知する</a></li>\n<li><a href=\"/posts/gatsbyjs-lighthouse-ci/#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n<li><a href=\"/posts/gatsbyjs-lighthouse-ci/#%E5%8F%82%E8%80%83\">参考</a></li>\n</ul>"}},"pageContext":{"slug":"/posts/gatsbyjs-lighthouse-ci"}},"staticQueryHashes":["1552397463","1669302033","3314088506","401334301","554596625","82304099"]}