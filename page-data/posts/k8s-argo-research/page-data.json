{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/k8s-argo-research","result":{"data":{"markdownRemark":{"id":"902c42ea-e54b-57a3-84d8-f77bb70e2ece","html":"<h1 id=\"argo-を調査してみた\" style=\"position:relative;\"><a href=\"#argo-%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F\" aria-label=\"argo を調査してみた permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>argo を調査してみた</h1>\n<h2 id=\"argoとは\" style=\"position:relative;\"><a href=\"#argo%E3%81%A8%E3%81%AF\" aria-label=\"argoとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>argoとは</h2>\n<p>Job を順次実行可能なk8s LikeなOSS</p>\n<h2 id=\"背景\" style=\"position:relative;\"><a href=\"#%E8%83%8C%E6%99%AF\" aria-label=\"背景 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>背景</h2>\n<p>シンプルなCronJob程度なら<a href=\"https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">k8sのCronJob</a>で十分だが、 \b<strong>A Job</strong> -> <strong>B Job</strong> -> <strong>C Job</strong> のような依存する順次処理は複雑になりがちで管理ができなくなる。</p>\n<h2 id=\"向いている環境\" style=\"position:relative;\"><a href=\"#%E5%90%91%E3%81%84%E3%81%A6%E3%81%84%E3%82%8B%E7%92%B0%E5%A2%83\" aria-label=\"向いている環境 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>向いている環境</h2>\n<p>k8sでアプリを管理、立ち上げており、複雑なJob実行に困っている場合</p>\n<h2 id=\"まずは-quick-start\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%9A%E3%81%AF-quick-start\" aria-label=\"まずは quick start permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まずは Quick Start</h2>\n<ol>\n<li>namespace, controller の作成</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"kube\"><pre class=\"language-kube\"><code class=\"language-kube\">kubectl create namespace argo\nkubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo/stable/manifests/install.yaml</code></pre></div>\n<ol start=\"2\">\n<li>権限の追加</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"kube\"><pre class=\"language-kube\"><code class=\"language-kube\">kubectl create rolebinding default-admin --clusterrole=admin --serviceaccount=default:default</code></pre></div>\n<ol start=\"3\">\n<li>Workflow の実行</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">argo submit --watch https://raw.githubusercontent.com/argoproj/argo/master/examples/hello-world.yaml\nargo submit --watch https://raw.githubusercontent.com/argoproj/argo/master/examples/coinflip.yaml\nargo submit --watch https://raw.githubusercontent.com/argoproj/argo/master/examples/loops-maps.yaml\nargo list\nargo get xxx-workflow-name-xxx\nargo logs xxx-pod-name-xxx #from get command above</code></pre></div>\n<ol start=\"4\">\n<li>argo ui の起動(Port-forward)</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl -n argo port-forward deployment/argo-server 2746:2746</code></pre></div>\n<p>2746ポートにつながったので <strong><a href=\"http://localhost:2746/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://localhost:2746/</a></strong> にアクセスしてみる</p>\n<p><img src=\"https://img.esa.io/uploads/production/attachments/15569/2020/05/20/82539/5427c37f-9031-4bb5-b190-fbbe164f2c1d.png\"></p>\n<h2 id=\"http-アクセスで任意のワークフローを起動\" style=\"position:relative;\"><a href=\"#http-%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E4%BB%BB%E6%84%8F%E3%81%AE%E3%83%AF%E3%83%BC%E3%82%AF%E3%83%95%E3%83%AD%E3%83%BC%E3%82%92%E8%B5%B7%E5%8B%95\" aria-label=\"http アクセスで任意のワークフローを起動 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HTTP アクセスで任意のワークフローを起動</h2>\n<ol>\n<li>OpenAPIのドキュメントを参照</li>\n<li><a href=\"https://raw.githubusercontent.com/argoproj/argo/master/api/openapi-spec/swagger.json\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://raw.githubusercontent.com/argoproj/argo/master/api/openapi-spec/swagger.json</a> を開いてコピー・ペースト</li>\n<li><a href=\"https://editor.swagger.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://editor.swagger.io/</a> でドキュメントを参照</li>\n</ol>\n<p>OpenAPIというAPIドキュメントがあるのでまずはどんなAPIが叩けるのか確認すると良い。</p>\n<p><img src=\"https://ucarecdn.com/7aa5b68e-f43d-46c9-8b52-f121a38a62da/\"></p>\n<blockquote>\n<p>認証が必要な場合</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">token=$(argo auth token)\ncurl -H &quot;Authorization: $token&quot; http://localhost:2746/api/v1/workflows/argo</code></pre></div>\n<ol start=\"2\">\n<li>ワークフローの確認 （適当なワークフローを登録しておく）</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl http://localhost:2746/api/v1/workflows/default</code></pre></div>\n<ol start=\"3\">\n<li>ワークフローの実行</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -X PUT http://localhost:2746/api/v1/workflows/default/coinflip-XXX/resubmit</code></pre></div>\n<p>実行される！！ </p>\n<p><img src=\"https://img.esa.io/uploads/production/attachments/15569/2020/05/20/82539/948bbb44-2cc7-40b1-b3a3-be57561e4fb1.png\"></p>\n<h3 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h3>\n<ul>\n<li><a href=\"https://github.com/argoproj/argo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/argoproj/argo</a></li>\n<li><a href=\"https://github.com/argoproj/argo/blob/master/docs/getting-started.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/argoproj/argo/blob/master/docs/getting-started.md</a></li>\n<li><a href=\"https://github.com/argoproj/argo/blob/master/docs/rest-api.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/argoproj/argo/blob/master/docs/rest-api.md</a></li>\n</ul>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>マイクロサービスの時代と言っても切っても切り離せないのがバッチ処理。k8sでもCronJobが乱立してきた環境にはなかなか向いているのではないでしょうか。</p>\n<p>まだ成長中のOSSなので今後に期待ですね。</p>","fields":{"slug":"/posts/k8s-argo-research","tagSlugs":["/tags/argo/","/tags/dev-ops/","/tags/web-development/","/tags/k-8-s/"]},"frontmatter":{"date":"2020-05-20T13:24:30.517Z","updatedDate":null,"tags":["argo","Dev Ops","Web Development","k8s"],"title":"k8sでのJob管理にargoで動かしてみる","socialImage":"https://ucarecdn.com/29634536-e9be-48da-aa3e-d36a8cb9d871/","category":"Programming"},"excerpt":"argo を調査してみた argoとは Job を順次実行可能なk8s LikeなOSS 背景 シンプルなCronJob程度ならk8sのCronJobで十分だが、 \bA Job -> B Job -> C Job のような依存する順次処理は複雑になりがちで管理ができなくなる。 …","tableOfContents":"<ul>\n<li>\n<p><a href=\"/posts/k8s-argo-research/#argo-%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F\">argo を調査してみた</a></p>\n<ul>\n<li><a href=\"/posts/k8s-argo-research/#argo%E3%81%A8%E3%81%AF\">argoとは</a></li>\n<li><a href=\"/posts/k8s-argo-research/#%E8%83%8C%E6%99%AF\">背景</a></li>\n<li><a href=\"/posts/k8s-argo-research/#%E5%90%91%E3%81%84%E3%81%A6%E3%81%84%E3%82%8B%E7%92%B0%E5%A2%83\">向いている環境</a></li>\n<li><a href=\"/posts/k8s-argo-research/#%E3%81%BE%E3%81%9A%E3%81%AF-quick-start\">まずは Quick Start</a></li>\n<li>\n<p><a href=\"/posts/k8s-argo-research/#http-%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E4%BB%BB%E6%84%8F%E3%81%AE%E3%83%AF%E3%83%BC%E3%82%AF%E3%83%95%E3%83%AD%E3%83%BC%E3%82%92%E8%B5%B7%E5%8B%95\">HTTP アクセスで任意のワークフローを起動</a></p>\n<ul>\n<li><a href=\"/posts/k8s-argo-research/#%E5%8F%82%E8%80%83\">参考</a></li>\n</ul>\n</li>\n<li><a href=\"/posts/k8s-argo-research/#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n</li>\n</ul>"}},"pageContext":{"slug":"/posts/k8s-argo-research"}},"staticQueryHashes":["1552397463","1669302033","3314088506","401334301","554596625","82304099"]}